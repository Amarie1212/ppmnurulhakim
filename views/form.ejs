<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title><%= title %></title>
  <link rel="icon" type="image/png" href="/img/logo ppm.png" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/styles.css"/>
  <link rel="stylesheet" href="/form.css"/>
  <link rel="stylesheet" href="/duty.css"/> <style>
    /* Styling khusus tombol di halaman form agar sama dengan halaman lain */
    .brand-wrap { display: flex; align-items: center; gap: 12px; }
    


    /* Layout Form Responsif */
    .form-wrap {
      width: min(980px, 94%); 
      margin: calc(var(--nav-h) + 32px) auto 64px; 
    }
    
    /* Tombol Aksi di Bawah Form */
    .actions { 
      display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; 
    }
    
    /* Di Mobile, tombol aksi jadi full width vertikal */
    @media (max-width: 640px) {
      .actions { flex-direction: column-reverse; }
      .actions .btn-ghost, .actions .btn-nav { width: 100%; justify-content: center; padding: 14px; }

      .form-title { font-size: 1.5rem; }
    }
  </style>
</head>
<body class="form-page layout-form">

<%- include('partials/santri_navbar', { title: 'Formulir Biodata', backLink: '/', showHamburger: false }) %>

<main class="form-wrap">
  <div class="form-card">
      <% if(data && data.status_biodata === 'REJECTED') { %>
        <div style="text-align:center; margin-bottom:24px;">
           <span style="display:inline-block; color:#ef4444; font-weight:600; font-size:1rem; padding:8px 16px; border-radius:100px; background:rgba(239,68,68,0.08);">
              Perbaiki: "<%= data.alasan_tolak || 'Data belum valid' %>"
           </span>
        </div>
      <% } else if(data && data.id) { %>
        <div style="text-align:center; margin-bottom:24px;">
          <span style="color:var(--accent); font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px; background:rgba(34,197,94,0.08); padding:6px 14px; border-radius:100px; border:1px solid rgba(34,197,94,0.15);">
            <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            Data Anda tersimpan. Silakan edit jika ada perubahan.
          </span>
        </div>
      <% } else { %>
        <div style="text-align:center; margin-bottom:24px; color:var(--muted); font-size:0.85rem;">
          Silakan lengkapi data diri Anda di bawah ini dengan benar.
        </div>
      <% } %>
    </p>

    <% if (typeof error !== 'undefined' && error) { %>
      <div style="background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); color:#ef4444; padding:14px; border-radius:12px; margin-bottom:24px; text-align:center; font-weight:600;">
        ⚠️ <%= error %>
      </div>
    <% } %>

    <form action="/form" method="POST" enctype="multipart/form-data">
      
      <input type="hidden" name="old_foto" value="<%= (data && data.foto_path) ? data.foto_path : '' %>">
      <input type="hidden" name="wa" value="<%= (data && data.wa) ? data.wa : (user.wa || '') %>">

      <div class="grid-12">

        <div class="col-12"><h3 class="sec-title">Data Akun</h3></div>

        <% const isEditable = (data && data.id) ? '' : 'readonly'; %>

        <div class="col-12">
          <label class="label">Nama Lengkap <span style="color:var(--danger)">*</span></label>
          <input class="input" name="nama" value="<%= user.name %>" <%= isEditable %> required style="font-weight:600;">
        </div>

        <div class="col-6">
          <label class="label">Email</label>
          <input type="email" class="input" value="<%= user.email %>" readonly style="opacity:0.7; cursor:default;">
        </div>

        <div class="col-6">
          <label class="label" style="display:block; margin-bottom:8px;">Password</label>
          <div style="position:relative; width:100%;">
            <input type="password" class="input" name="password" id="password" value="<%= savedPassword %>" style="width:100%; padding-right: 45px; color: var(--text); background: var(--input-bg);">
            <button type="button" onclick="togglePassword()" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); background:transparent; border:none; cursor:pointer; padding:6px; display:flex; align-items:center; justify-content:center; z-index:10; color:var(--text); opacity:0.7;" title="Lihat Password">
              <svg id="eyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px; height:20px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
          </div>
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Data Diri</h3></div>

        <div class="col-6">
          <label class="label">Jenis Kelamin <span style="color:var(--danger)">*</span></label>
          <select class="select" name="jk" required>
            <option value="">— Pilih —</option>
            <option value="L" <%= (data && data.jk === 'L') ? 'selected' : '' %>>Laki-laki</option>
            <option value="P" <%= (data && data.jk === 'P') ? 'selected' : '' %>>Perempuan</option>
          </select>
        </div>

        <div class="col-6">
          <label class="label">No WhatsApp</label>
          <div style="background:var(--input-bg); padding:11px 12px; border-radius:4px; border:1px solid var(--input-border); font-weight:600; color:var(--text); display:flex; align-items:center; justify-content:space-between;">
            <span><%= (data && data.wa) ? data.wa : (user.wa || '-') %></span>
            <span style="font-size:0.75rem; color:var(--muted); font-weight:400;">(Terverifikasi)</span>
          </div>
        </div>

        <div class="col-6">
          <label class="label">Pernah Mondok? <span style="color:var(--danger)">*</span></label>
          <select class="select" name="pernah_mondok" required>
            <option value="">— Pilih —</option>
            <option value="true" <%= (data && String(data.pernah_mondok) === 'true') ? 'selected' : '' %>>Ya</option>
            <option value="false" <%= (data && String(data.pernah_mondok) === 'false') ? 'selected' : '' %>>Tidak</option>
          </select>
        </div>

        <div class="col-6">
          <label class="label">Mempunyai Sertifikat Penyampai? <span style="color:var(--danger)">*</span></label>
          <select class="select" name="lulus_muballigh" id="sertifikatSelect" required onchange="toggleSertifikatUpload()">
            <option value="">— Pilih —</option>
            <option value="true" <%= (data && String(data.lulus_muballigh) === 'true') ? 'selected' : '' %>>Ya</option>
            <option value="false" <%= (data && String(data.lulus_muballigh) === 'false') ? 'selected' : '' %>>Tidak</option>
          </select>
          
          <!-- Conditional Upload Sertifikat -->
          <div id="sertifikatUpload" style="display:none; margin-top:12px; background:var(--bg); border:1px solid var(--border); padding:12px; border-radius:4px;">
             <label class="label" style="font-size:0.85rem; margin-bottom:8px;">Upload Sertifikat/Bukti (JPG/PNG/PDF)</label>
             <% if (data && data.sertifikat_path) { %>
                <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px; font-size:0.8rem;">
                   <span style="color:var(--accent);">✅ File tersimpan</span>
                   <a href="<%= data.sertifikat_path %>" target="_blank" style="color:var(--text); text-decoration:underline;">Lihat</a>
                </div>
             <% } %>
             <input type="file" class="file id-doc" name="sertifikat" accept=".jpg,.jpeg,.png,.pdf">
             <input type="hidden" name="old_sertifikat" value="<%= (data && data.sertifikat_path) ? data.sertifikat_path : '' %>">
          </div>
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Alamat Domisili</h3></div>
        <div class="col-6"><label class="label">Kelurahan <span style="color:var(--danger)">*</span></label><input class="input" name="kelurahan" value="<%= (data && data.kelurahan) || '' %>" required></div>
        <div class="col-6"><label class="label">Kecamatan <span style="color:var(--danger)">*</span></label><input class="input" name="kecamatan" value="<%= (data && data.kecamatan) || '' %>" required></div>
        <div class="col-6"><label class="label">Kota/Kabupaten <span style="color:var(--danger)">*</span></label><input class="input" name="kota_kab" value="<%= (data && data.kota_kab) || '' %>" required></div>
        <div class="col-6"><label class="label">Provinsi <span style="color:var(--danger)">*</span></label><input class="input" name="provinsi" value="<%= (data && data.provinsi) || '' %>" required></div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Asal Majlis Taklim</h3></div>

        <div class="col-4">
          <label class="label">Kelompok <span style="color:var(--danger)">*</span></label>
          <input class="input" name="kelompok" value="<%= (data && data.kelompok) ? data.kelompok : user.kelompok %>" required>
        </div>

        <div class="col-4">
          <label class="label">Desa <span style="color:var(--danger)">*</span></label>
          <input class="input" name="desa" value="<%= (data && data.desa) ? data.desa : user.desa %>" required>
        </div>

        <div class="col-4">
          <label class="label">Daerah <span style="color:var(--danger)">*</span></label>
          <input class="input" name="daerah" value="<%= (data && data.daerah) ? data.daerah : user.daerah %>" required>
        </div>

        <div class="col-12">
          <label class="label">Nomor Kyai Kelompok</label>
          <input class="input" name="no_ki" value="<%= (data && data.no_ki) || '' %>" pattern="^08[0-9]{7,13}$">
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Informasi Akademik</h3></div>
        <div class="col-6"><label class="label">Kampus <span style="color:var(--danger)">*</span></label><input class="input" name="kampus" value="<%= (data && data.kampus) ? data.kampus : (user.kampus || '') %>" required></div>
        <div class="col-6"><label class="label">Prodi / Jurusan <span style="color:var(--danger)">*</span></label><input class="input" name="prodi" value="<%= (data && data.prodi) ? data.prodi : (user.prodi || '') %>" required></div>
        <div class="col-6">
          <label class="label">Jenjang <span style="color:var(--danger)">*</span></label>
          <select class="select" name="jenjang" required>
            <option value="">— Pilih —</option>
            <% ['S1','D4','D3','S2'].forEach(opt => { %>
              <option value="<%= opt %>" <%= (data && data.jenjang === opt) ? 'selected' : '' %>><%= opt %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-6"><label class="label">Angkatan Kuliah <span style="color:var(--danger)">*</span></label><input class="input" name="angkatan" value="<%= (data && data.angkatan) || '' %>" pattern="^[0-9]{4}$" placeholder="Contoh: 2025" required></div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Data Orang Tua</h3></div>

        <div class="col-6 smooth-box">
          <div class="sub" style="color:var(--accent); margin-bottom:10px;">Data Ayah</div>
          <label class="label">Nama Lengkap <span style="color:var(--danger)">*</span></label><input class="input" name="ayah_nama" value="<%= (data && data.ayah_nama) || '' %>" required onblur="toTitle(this)">
          <label class="label mt">Nomor HP</label><input class="input" name="ayah_hp" value="<%= (data && data.ayah_hp) || '' %>" pattern="^08[0-9]{7,13}$">
        </div>

        <div class="col-6 smooth-box">
          <div class="sub" style="color:var(--accent); margin-bottom:10px;">Data Ibu</div>
          <label class="label">Nama Lengkap <span style="color:var(--danger)">*</span></label><input class="input" name="ibu_nama" value="<%= (data && data.ibu_nama) || '' %>" required onblur="toTitle(this)">
          <label class="label mt">Nomor HP</label><input class="input" name="ibu_hp" value="<%= (data && data.ibu_hp) || '' %>" pattern="^08[0-9]{7,13}$">
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Dokumen Pendukung</h3></div>
        <div class="col-12" style="margin-bottom:12px;">
           <div style="background:var(--bg); border:1px dashed var(--border); padding:12px; border-radius:4px; font-size:0.9rem; color:var(--text); display:flex; gap:10px; align-items:center;">
               <svg style="width:20px;height:20px;color:var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
               <span>Wajib upload <strong>salah satu</strong>: Kartu Keluarga (KK) <u>ATAU</u> KTP.</span>
           </div>
        </div>

        <div class="col-6">
          <label class="label">Kartu Keluarga (KK)</label>
          <% if (data && data.kk_path) { %>
            <div style="margin-bottom:10px; padding:12px; background:var(--input-bg); border:1px solid var(--input-border); border-radius:4px;">
              <div style="display:flex; align-items:center; gap:8px; font-size:0.85rem;">
                <svg style="width:16px;height:16px; color:var(--accent);" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <span style="color:var(--text);">KK sudah diupload</span>
                <a href="<%= data.kk_path %>" target="_blank" style="color:var(--accent); margin-left:auto;">Lihat</a>
              </div>
            </div>
          <% } %>
          <input type="file" class="file id-doc" name="kk" accept=".jpg,.jpeg,.png">
          <input type="hidden" name="old_kk" value="<%= (data && data.kk_path) ? data.kk_path : '' %>">
        </div>

        <div class="col-6">
          <label class="label">KTP</label>
          <% if (data && data.ktp_path) { %>
            <div style="margin-bottom:10px; padding:12px; background:var(--input-bg); border:1px solid var(--input-border); border-radius:4px;">
              <div style="display:flex; align-items:center; gap:8px; font-size:0.85rem;">
                <svg style="width:16px;height:16px; color:var(--accent);" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <span style="color:var(--text);">KTP sudah diupload</span>
                <a href="<%= data.ktp_path %>" target="_blank" style="color:var(--accent); margin-left:auto;">Lihat</a>
              </div>
            </div>
          <% } %>
          <input type="file" class="file id-doc" name="ktp" accept=".jpg,.jpeg,.png">
          <input type="hidden" name="old_ktp" value="<%= (data && data.ktp_path) ? data.ktp_path : '' %>">
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12"><h3 class="sec-title">Upload Foto</h3></div>
        <div class="col-12">
          <label class="label">Foto Formal (Maks 5MB) <span style="color:var(--danger)">*</span></label>
          <% if(data && data.foto_path) { %>
            <div style="margin-bottom:12px; padding:12px; background:var(--input-bg); border-radius:4px; display:flex; align-items:center; gap:14px; border:1px solid var(--input-border);">
              <img src="<%= data.foto_path %>" style="width:56px; height:68px; object-fit:cover; border-radius:3px; background:#fff; border:1px solid var(--input-border);">
              <div>
                <span style="font-weight:700; font-size:0.9rem; display:block; color:var(--text)">Foto Tersimpan</span>
                <span style="font-size:0.85rem; color:var(--muted)">Biarkan kosong jika tidak ingin mengganti.</span>
              </div>
            </div>
          <% } %>
          <input type="file" class="file" name="foto" accept=".jpg,.jpeg,.png" <%= (data && data.foto_path) ? '' : 'required' %>>
        </div>

        <div class="col-12 actions">
          <a href="/" class="btn-ghost" style="text-decoration:none;">Batal</a>
          <button class="btn-nav" type="submit" style="padding:12px 24px; font-size:1rem;">
            <%= (data && data.id) ? 'Simpan Perubahan' : 'Kirim Biodata' %>
          </button>
        </div>
      </div>
    </form>
  </div>
</main>

<button id="themeFab" class="theme-fab" aria-label="Ganti tema" title="Ganti tema"></button>

<footer class="footer">
  <div class="container"><p>© <%= new Date().getFullYear() %> PPM Nurul Hakim Jatinangor</p></div>
</footer>

<script>
  function toTitle(el){ const v=(el.value||'').toLowerCase().trim(); if(!v) return; el.value=v.replace(/\b([a-z])/g,c=>c.toUpperCase()); }

  // Toggle Password
  function togglePassword() {
    const input = document.getElementById('password');
    const icon = document.getElementById('eyeIcon');

    // Toggle Icon & Input Type
    if (input.type === 'password') {
      input.type = 'text';
      icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
      icon.parentElement.style.color = 'var(--text)';
      icon.parentElement.style.opacity = '1';
    } else {
      input.type = 'password';
      icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      icon.parentElement.style.color = 'var(--text)';
      icon.parentElement.style.opacity = '0.7';
    }
  }

  // Toggle Sertifikat Upload
  function toggleSertifikatUpload() {
    const sel = document.getElementById('sertifikatSelect');
    const wrap = document.getElementById('sertifikatUpload');
    if (sel.value === 'true') {
      wrap.style.display = 'block';
    } else {
      wrap.style.display = 'none';
      // Optional: Clear file input if hidden? 
      // document.querySelector('input[name="sertifikat"]').value = '';
    }
  }
  // Run on init
  toggleSertifikatUpload();

  // Validation: Must have at least one ID document (KK or KTP)
  document.querySelector('form').addEventListener('submit', function(e) {
      const kk = document.querySelector('input[name="kk"]');
      const ktp = document.querySelector('input[name="ktp"]');
      const oldKk = document.querySelector('input[name="old_kk"]').value;
      const oldKtp = document.querySelector('input[name="old_ktp"]').value;

      const hasKk = (kk.files.length > 0) || oldKk;
      const hasKtp = (ktp.files.length > 0) || oldKtp;

      if (!hasKk && !hasKtp) {
          e.preventDefault();
          
          // Custom Modal for Error
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:9999; display:flex; justify-content:center; align-items:center; padding:20px;';
          modal.innerHTML = `
            <div style="background:var(--bg-2); border:1px solid var(--border); border-radius:6px; max-width:400px; width:100%; padding:24px; text-align:center; box-shadow:0 25px 50px rgba(0,0,0,0.5); animation:modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
              <div style="width:50px; height:50px; background:rgba(239,68,68,0.1); color:#ef4444; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
              </div>
              <h3 style="margin:0 0 8px; font-size:1.1rem; font-weight:700; color:var(--text);">Dokumen Belum Lengkap</h3>
              <p style="margin:0 0 20px; color:var(--muted); line-height:1.5; font-size:0.9rem;">
                Harap upload salah satu dokumen identitas:<br><strong>Kartu Keluarga (KK)</strong> ATAU <strong>KTP</strong>.
              </p>
              <button id="closeErrorModal" style="background:#ef4444; color:#fff; border:none; padding:10px 20px; border-radius:4px; font-weight:600; cursor:pointer; width:100%; font-size:0.95rem;">Siap, lengkapi sekarang</button>
            </div>
          `;
          document.body.appendChild(modal);
          
          // Animation style if not present
          if (!document.getElementById('modalAnimStyle')) {
             const style = document.createElement('style');
             style.id = 'modalAnimStyle';
             style.textContent = '@keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }';
             document.head.appendChild(style);
          }
          
          document.getElementById('closeErrorModal').onclick = () => {
            modal.remove();
            kk.scrollIntoView({ behavior: 'smooth', block: 'center' });
            kk.focus();
          };
      }
  });

  const root=document.documentElement;
  function setFabIcon(theme){
    const sun='<svg class="icon" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79L3.5 4.5l1.79 1.79 1.47-1.45zM1 13h3v-2H1v2zm10-9h2V1h-2v3zm7.24.84L18.5 4.5l-1.46 1.47 1.79 1.79 1.41-1.41zM20 13h3v-2h-3v2zm-7 7h2v-3h-2v3zm5.74-2.16l1.79 1.79 1.41-1.41-1.79-1.79-1.41 1.41zM4.5 18.5l1.79-1.79-1.41-1.41-1.79 1.79 1.41 1.41zM12 6a6 6 0 1 1 0 12 6 6 0 0 1 0-12z"></path></svg>';
    const moon='<svg class="icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
    const fab=document.getElementById('themeFab'); if(fab) fab.innerHTML=(theme==='light')?moon:sun;
  }
  function applyTheme(theme){
    if(theme==='light') root.setAttribute('data-theme','light'); else root.removeAttribute('data-theme');
    localStorage.setItem('theme',theme); setFabIcon(theme);
    const fab=document.getElementById('themeFab'); if(fab){ fab.classList.add('spin'); setTimeout(()=>fab.classList.remove('spin'),400); }
  }
  (function initTheme(){
    const saved=localStorage.getItem('theme');
    if(saved) applyTheme(saved); else {
      const prefersLight=window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      applyTheme(prefersLight?'light':'dark');
    }
    document.getElementById('themeFab')?.addEventListener('click',()=>{
      const isLight=root.getAttribute('data-theme')==='light';
      applyTheme(isLight?'dark':'light');
    });
  })();
</script>
</body>
</html>

