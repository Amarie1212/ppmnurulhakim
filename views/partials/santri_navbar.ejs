<% 
  const navTitle = typeof title !== 'undefined' ? title : 'PPM Nurul Hakim';
  const navBack = typeof backLink !== 'undefined' ? backLink : '/';
%>

<header class="navbar logged-in">
  <div class="container nav-inner">
    <div class="brand-wrap">
      <a href="<%= navBack %>" class="btn-back-inline" title="Kembali">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </a>
      <div class="brand"><%= navTitle %></div>
    </div>

    <div class="right-actions">
      <% if (user && user.role === 'santri' && (typeof showHamburger === 'undefined' || showHamburger)) { %>
        <button id="santriToggle" class="nav-toggle">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </button>
      <% } %>
    </div>
  </div>
</header>

<% if (user && user.role === 'santri') { %>
  <style>
    /* 
      SANTRI MENU RESPONSIVE 
      - Mobile (< 768px): Popup Dropdown
      - Desktop (> 769px): Sliding Sidebar from Right
    */

    /* --- BASE STYLES --- */
    .brand-wrap { margin-left: -8px; }
    .brand {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: -0.01em;
    }
    @media (max-width: 768px) {
      .brand { font-size: 0.95rem; }
    }

    /* Container base */
    #santriMobileMenu {
      display: none; /* Toggled by JS */
      position: fixed;
      z-index: 2005;
      background: var(--bg-2); /* Usually white */
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
    }
    
    #santriMobileScrim {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2004;
      opacity: 0;
      transition: opacity .2s;
    }
    #santriMobileScrim.open {
      display: block;
      opacity: 1;
    }

    /* --- ITEM STYLES (Shared) --- */
    #santriMobileMenu .admin-dd-head {
      padding: 24px 24px 20px 24px; /* More roomy top padding */
      background: var(--bg-2);
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .admin-dd-title { font-weight: 800; font-size: 1.25rem; color: var(--text); letter-spacing: -0.02em; }
    .admin-dd-sub { font-size: 0.9rem; color: var(--muted); margin-top: 4px; font-weight: 400; }

    #santriMobileMenu .admin-dd-item {
      padding: 16px 24px; /* Wider padding */
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      color: var(--text);
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
      line-height: 1.5;
    }
    #santriMobileMenu .admin-dd-item:hover { background: var(--bg-3); }
    #santriMobileMenu .admin-dd-item.danger { color: #ef4444; }

    /* Special Colors for Status Text */
    .item-highlight-pending {
      color: #d97706 !important; /* Amber-600 (Emas/Kuning Gelap) */
      font-weight: 700;
      background: rgba(217, 119, 6, 0.03); /* Subtle tint */
    }
    .item-highlight-warning {
      color: #ef4444 !important; /* Red */
      font-weight: 700;
      background: rgba(239, 68, 68, 0.03);
    }

    /* Badge for "Status Akun" */
    /* Badge for "Status Akun" */
    .popup-badge {
      font-size: 0.75rem; 
      font-weight: 700; 
      padding: 6px 12px; 
      border-radius: 6px;
      text-transform: capitalize; /* Ensure "Terverifikasi" not uppercase */
    }
    .popup-badge.verified { color: #15803d; background: #dcfce7; /* Green-700 on Green-100 */ }
    .popup-badge.pending { color: #b45309; background: #fef3c7; /* Amber-700 on Amber-100 */ }
    .popup-badge.rejected { color: #b91c1c; background: #fee2e2; /* Red-700 on Red-100 */ }
    
    .header-dd-divider { height: 1px; background: var(--border); }

    /* --- MOBILE SPECIFIC (POPUP) --- */
    @media (max-width: 768px) {
      #santriMobileMenu {
        top: calc(var(--nav-h) + 10px);
        right: 16px;
        width: 290px;
        border-radius: 12px;
        transform-origin: top right;
        transform: scale(0.97) translateY(-8px);
        opacity: 0;
        transition: transform .2s ease-out, opacity .15s ease;
        visibility: hidden;
      }
      #santriMobileMenu.open {
        visibility: visible;
        transform: scale(1) translateY(0);
        opacity: 1;
        display: flex;
        animation: santriPopIn .2s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      #santriMobileMenu .admin-dd-head { padding: 16px; align-items: center; }
      .admin-dd-title { font-size: 1rem; }
      #santriMobileMenu .admin-dd-item { padding: 12px 16px; }

      .panel-close-btn { display: none; }
      .panel-footer-santri { display: none; }
      .mobile-logout { display: flex; }
    }
    @keyframes santriPopIn {
      0% { transform: scale(0.97) translateY(-8px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    /* --- DESKTOP SPECIFIC (SIDEBAR) --- */
    @media (min-width: 769px) {
      #santriMobileMenu {
        top: 0; right: 0; bottom: 0;
        width: 360px; /* Lebar Sidebar ditingkatkan */
        height: 100vh;
        border-radius: 0;
        border-left: 1px solid var(--border);
        box-shadow: -4px 0 24px rgba(0,0,0,0.08); /* Smoother shadow */
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: flex;
        visibility: visible;
        z-index: 3000;
        padding-top: 0;
      }
      #santriMobileMenu.open {
        transform: translateX(0);
      }
      .mobile-logout { display: none !important; }
      .panel-footer-santri {
        margin-top: auto;
        padding: 24px;
        border-top: 1px solid var(--border);
        display: block;
      }
      .panel-close-btn {
        background: transparent; 
        border: 1px solid var(--border);
        color: var(--text); 
        border-radius: 8px; 
        width: 36px; height: 36px;
        cursor: pointer; 
        display: grid; place-items: center; 
        font-size: 1.25rem;
        transition: all 0.2s;
      }
      .panel-close-btn:hover {
        border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.05);
      }
    }
    
    /* Logout Btn Style (Desktop) */
    .logout-btn-santri {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 12px; border-radius: 8px; /* Rounded 8px sesuai design system */
      border: 1px solid #ef4444; color: #ef4444;
      font-weight: 600; transition: 0.2s; text-decoration: none;
      background: transparent;
    }
    .logout-btn-santri:hover { background: #ef4444; color: white; }
  </style>

  <div id="santriMobileMenu">
    <div class="admin-dd-head">
      <div>
        <div class="admin-dd-title">Menu Santri</div>
        <div class="admin-dd-sub">Halo, <%= user.name %></div>
      </div>
      <button class="panel-close-btn" id="closeSantriPanel" title="Tutup">Ã—</button>
    </div>
    
    <div style="flex: 1; overflow-y: auto;">
      <!-- Shared CSS for Accordion -->
      <style>
         .reason-drawer { 
            display: grid; grid-template-rows: 0fr; 
            transition: grid-template-rows 0.3s ease-out; 
            background: rgba(239, 68, 68, 0.05);
         }
         .reason-drawer.open { grid-template-rows: 1fr; }
         .reason-inner { overflow: hidden; }
         .reason-icon { transition: transform 0.3s; }
         .reason-trigger.open .reason-icon { transform: rotate(180deg); }
         .reason-trigger.open { background: rgba(239, 68, 68, 0.05) !important; }
      </style>

      <% if (user.status === 'REJECTED') { %>
        <!-- Status Akun REJECTED - Clickable with dropdown -->
        <div onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('open'); event.stopPropagation();" class="admin-dd-item reason-trigger" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
          <span style="font-weight: 500;">Status Akun</span>
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="popup-badge rejected">Ditolak</span>
            <svg class="reason-icon" style="width:16px; height:16px; color:#ef4444;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
        </div>
        <div class="reason-drawer">
          <div class="reason-inner">
            <a href="/edit-akun" style="display:block; padding:16px 24px; text-decoration:none;" onmouseover="this.style.background='rgba(239, 68, 68, 0.08)'" onmouseout="this.style.background='transparent'">
              <div style="font-size:0.85rem; color:#ef4444; font-weight:600; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Alasan Penolakan:</div>
              <div style="font-size:0.95rem; color:var(--text); line-height:1.5; font-weight:400;">"<%= user.alasan_tolak || 'Data akun tidak valid.' %>"</div>
              <div style="margin-top:8px; font-size:0.85rem; color:#ef4444; font-weight:600; display:flex; align-items:center; gap:6px;">
                Perbaiki Data &rarr;
              </div>
            </a>
          </div>
        </div>
      <% } else { %>
        <!-- 1. STATUS AKUN (Badge Layout) - Normal -->
        <div class="admin-dd-item" style="cursor: default; justify-content:space-between;">
          <span style="font-weight: 500;">Status Akun</span>
          <% if(user.status === 'PENDING') { %>
            <span class="popup-badge pending">Menunggu</span>
          <% } else { %>
            <span class="popup-badge verified">Terverifikasi</span>
          <% } %>
        </div>
      <% } %>
      
      <% if (user.status !== 'PENDING' && user.status !== 'REJECTED') { %>
        
        <!-- 2. PENGUMUMAN (Hanya jika sudah bayar & terverifikasi) -->
        <% if (user.hasPaid && !user.paymentPending && !user.paymentRejected) { %>
          <a href="/info-santri" class="admin-dd-item">Pengumuman & Info</a>
        <% } %>

        <% if (user.biodataRejected) { %>
           <!-- BIODATA DITOLAK -->
           <div onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('open'); event.stopPropagation();" class="admin-dd-item reason-trigger item-highlight-warning" style="cursor:pointer; justify-content:space-between; align-items:center;">
              <span>Edit Biodata (Ditolak)</span>
              <svg class="reason-icon" style="width:18px; height:18px; color:#ef4444;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
           </div>
           <div class="reason-drawer">
              <div class="reason-inner">
                 <a href="/form" style="display:block; padding:16px 24px; text-decoration:none; border-bottom:1px solid #fee2e2;" onmouseover="this.style.background='rgba(239, 68, 68, 0.05)'" onmouseout="this.style.background='transparent'">
                    <div style="font-size:0.85rem; color:#ef4444; font-weight:600; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Alasan:</div>
                    <div style="font-size:0.95rem; color:var(--text); line-height:1.5; font-weight:400;">"<%= user.biodataReason || 'Mohon perbaiki data.' %>"</div>
                 </a>
              </div>
           </div>

        <% } else if (!user.isBiodataEmpty && !user.biodataVerified) { %>
           <!-- BIODATA PENDING (Amber) -->
           <a href="/form" class="admin-dd-item" style="justify-content:space-between; color:var(--text); font-weight:500;">
              <span>Edit Biodata Lengkap</span>
              <span class="popup-badge pending">Menunggu..</span>
           </a>

        <% } else if (user.isBiodataEmpty) { %>
           <!-- BIODATA KOSONG (Red) -->
           <a href="/form" class="admin-dd-item item-highlight-warning">
              Isi Biodata (Wajib)
           </a>
        
        <% } else { %>
           <!-- BIODATA VERIFIED -->
           <a href="/form" class="admin-dd-item">Edit Biodata Lengkap</a>

           <!-- 4. PEMBAYARAN -->
           <% if (!user.isBiodataEmpty) { %>
              <% if (user.paymentRejected) { %>
                 <!-- PEMBAYARAN DITOLAK -->
                 <div onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('open'); event.stopPropagation();" class="admin-dd-item reason-trigger item-highlight-warning" style="cursor:pointer; justify-content:space-between; align-items:center;">
                    <span>Shodaqoh (Ditolak)</span>
                    <svg class="reason-icon" style="width:18px; height:18px; color:#ef4444;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                 </div>
                 <div class="reason-drawer">
                    <div class="reason-inner">
                       <a href="/pembayaran" style="display:block; padding:16px 24px; text-decoration:none; border-bottom:1px solid #fee2e2;" onmouseover="this.style.background='rgba(239, 68, 68, 0.05)'" onmouseout="this.style.background='transparent'">
                          <div style="font-size:0.85rem; color:#ef4444; font-weight:600; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Alasan:</div>
                          <div style="font-size:0.95rem; color:var(--text); line-height:1.5; font-weight:400;">"<%= user.paymentReason || 'Bukti invalid.' %>"</div>
                       </a>
                    </div>
                 </div>

              <% } else if (user.paymentPending) { %>
                 <!-- PEMBAYARAN PENDING (Amber) -->
                 <a href="/pembayaran" class="admin-dd-item" style="justify-content:space-between; align-items:center; color:var(--text); font-weight:500;">
                    <span>Shodaqoh Operasional</span>
                    <span class="popup-badge pending">Menunggu..</span>
                 </a>
                 
              <% } else if (user.hasPaid) { %>
                 <!-- PEMBAYARAN VERIFIED -->
                 <a href="/pembayaran" class="admin-dd-item">Shodaqoh Operasional</a>
                 
              <% } else { %>
                 <!-- BELUM BAYAR (Red) -->
                 <a href="/pembayaran" class="admin-dd-item item-highlight-warning">
                    Shodaqoh Operasional (Wajib)
                 </a>
              <% } %>
           <% } %>

        <% } %>
      <% } %>

      <!-- Divider -->
      <div class="header-dd-divider"></div>
      
      <!-- Mobile: Inline Logout -->
      <a class="admin-dd-item danger mobile-logout" href="/logout">Logout</a>
    </div>
    
    <!-- Desktop: Footer Logout -->
    <div class="panel-footer-santri">
      <a href="/logout" class="logout-btn-santri">Logout</a>
    </div>

  </div>
  <div id="santriMobileScrim"></div>

  <script>
    (function(){
      const btn = document.getElementById('santriToggle');
      const menu = document.getElementById('santriMobileMenu');
      const scrim = document.getElementById('santriMobileScrim');
      const closeBtn = document.getElementById('closeSantriPanel');

      if(!btn || !menu) return;

      function openMenu() {
        btn.classList.add('active');
        if (window.innerWidth <= 768) {
             menu.style.display = 'flex';
        }
        menu.offsetHeight;
        menu.classList.add('open');
        scrim.classList.add('open');
      }

      function closeMenu() {
        btn.classList.remove('active');
        menu.classList.remove('open');
        scrim.classList.remove('open');
        if (window.innerWidth <= 768) {
            setTimeout(() => {
              if(!menu.classList.contains('open')) menu.style.display = 'none';
            }, 300);
        }
      }

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.contains('open') ? closeMenu() : openMenu();
      });

      if(closeBtn) closeBtn.addEventListener('click', closeMenu);
      scrim.addEventListener('click', closeMenu);
      menu.querySelectorAll('a').forEach(l => l.addEventListener('click', closeMenu));
    })();
  </script>
<% } %>
